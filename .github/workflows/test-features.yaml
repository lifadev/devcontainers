name: Test features (arm64)

on:
  workflow_call:

jobs:
  setup:
    name: Setup

    permissions:
      contents: read

    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate matrix
        id: generate-matrix
        run: |
          python3 <<EOF >> $GITHUB_OUTPUT

          import json
          from pathlib import Path

          os = [
            { "name": "ubuntu-24.04" },
            { "name": "ubuntu-24.04-arm" },
          ]

          features = [
            { "name": feature.name }
            for feature in Path("features/src").iterdir()
            if feature.is_dir()
          ]

          if features:
            print(f'matrix={json.dumps({"os": os, "feature": features})}')

    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}

  test:
    name: Test
    if: ${{ needs.setup.outputs.matrix != '' && toJson(fromJson(needs.setup.outputs.matrix)) != '{}' }}
    needs: setup

    permissions:
      contents: read

    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    runs-on: ${{ matrix.os.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test features
        run: |
          npx -y @devcontainers/cli features test \
            -f ${{ matrix.feature.name }} \
            --skip-autogenerated \
            --skip-duplicated \
            ./features
